================================================================================
                        OCR核心模块 API 使用指南
================================================================================

【模块说明】
这是一个从 Umi-OCR 项目中提取的完全独立、最小化OCR识别核心模块。
已内置完整的 PaddleOCR 引擎和模型文件，可直接复制到任何地方使用。
去除了UI、任务队列等复杂功能，仅保留核心识别能力。
使用JSON配置文件管理参数，提供简洁的输入输出接口。

【目录结构】
ocr_core/                       # 完全独立的OCR核心模块
  ├── paddleocr_engine/         # 内置OCR引擎（约200MB）
  │   ├── PaddleOCR-json.exe   # 引擎可执行文件
  │   ├── models/               # 模型文件夹
  │   └── *.dll                 # 依赖库
  ├── __init__.py               # 包初始化文件
  ├── ocr_engine.py             # 核心引擎类
  ├── config.json               # 配置文件
  ├── example.py                # 完整使用示例
  ├── test_simple.py            # 简单测试脚本
  ├── API_GUIDE.txt             # 本文件
  └── README.md                 # 说明文档

【快速开始】
1. 确保配置文件 config.json 中的路径正确
2. 导入模块: from ocr_core import OCREngine
3. 创建实例: engine = OCREngine("config.json")
4. 初始化: engine.initialize()
5. 识别图片: result = engine.recognize_image("image.jpg")
6. 关闭引擎: engine.close()

================================================================================
                            核心类: OCREngine
================================================================================

【类说明】
OCR识别引擎核心类，封装了PaddleOCR-json引擎的调用。

【构造函数】
OCREngine(config_path="config.json")
    
    参数:
        config_path (str): 配置文件路径，默认为 "config.json"
    
    返回:
        OCREngine实例

【主要方法】

1. initialize()
   功能: 初始化OCR引擎进程
   参数: 无
   返回: bool - 成功返回True，失败返回False
   
   示例:
       engine = OCREngine("config.json")
       if engine.initialize():
           print("初始化成功")

2. recognize_image(image_path)
   功能: 识别本地图片文件
   参数: 
       image_path (str): 图片文件路径
   返回: dict - 识别结果字典
       {
           "code": int,      # 状态码 (100=成功, 101=无文字, 其他=失败)
           "data": list,     # 识别结果列表
           "score": float    # 平均置信度 (0-1)
       }
   
   识别结果data格式（当code=100时）:
       [
           {
               "text": "识别的文字",
               "score": 0.95,
               "box": [[x1,y1], [x2,y2], [x3,y3], [x4,y4]]
           },
           ...
       ]
   
   示例:
       result = engine.recognize_image("test.jpg")
       if result["code"] == 100:
           for item in result["data"]:
               print(f"文字: {item['text']}, 置信度: {item['score']}")

3. recognize_bytes(image_bytes)
   功能: 识别图片字节流
   参数:
       image_bytes (bytes): 图片的字节流数据
   返回: dict - 识别结果字典（格式同 recognize_image）
   
   示例:
       with open("image.jpg", "rb") as f:
           image_bytes = f.read()
       result = engine.recognize_bytes(image_bytes)

4. recognize_base64(image_base64)
   功能: 识别base64编码的图片
   参数:
       image_base64 (str): 图片的base64字符串
   返回: dict - 识别结果字典（格式同 recognize_image）
   
   示例:
       import base64
       with open("image.jpg", "rb") as f:
           base64_str = base64.b64encode(f.read()).decode()
       result = engine.recognize_base64(base64_str)

5. batch_recognize(image_paths)
   功能: 批量识别多张图片
   参数:
       image_paths (list): 图片路径列表
   返回: list - 识别结果列表
   
   示例:
       paths = ["img1.jpg", "img2.png", "img3.jpg"]
       results = engine.batch_recognize(paths)
       for result in results:
           print(f"图片: {result['path']}")
           print(f"状态: {result['code']}")

6. extract_text(result)
   功能: 从识别结果中提取纯文本
   参数:
       result (dict): recognize_* 方法返回的结果字典
   返回: str - 纯文本字符串，每行用换行符分隔
   
   示例:
       result = engine.recognize_image("test.jpg")
       text = engine.extract_text(result)
       print(text)

7. close()
   功能: 关闭OCR引擎，释放资源
   参数: 无
   返回: 无
   
   示例:
       engine.close()

【上下文管理器】
OCREngine 支持 with 语句，可以自动管理资源：

    with OCREngine("config.json") as engine:
        result = engine.recognize_image("test.jpg")
        text = engine.extract_text(result)
    # 自动调用 close()

【类属性】
SUPPORTED_FORMATS (list): 支持的图片格式列表
    [".jpg", ".jpe", ".jpeg", ".jfif", ".png", 
     ".webp", ".bmp", ".tif", ".tiff"]

================================================================================
                            配置文件说明
================================================================================

【配置文件: config.json】
JSON格式的配置文件，用于设置OCR引擎参数。

{
    "exe_path": "引擎可执行文件路径",
    "models_path": "模型文件夹路径",
    "language": "语言配置文件",
    "cpu_threads": CPU线程数,
    "enable_mkldnn": 是否启用MKL-DNN加速,
    "cls": 是否启用方向分类,
    "limit_side_len": 图片长边压缩限制
}

【配置项详细说明】

1. exe_path (必需)
   类型: string
   说明: OCR引擎可执行文件的路径
   示例: "../UmiOCR-data/plugins/win7_x64_PaddleOCR-json/PaddleOCR-json.exe"

2. models_path (可选)
   类型: string
   说明: 模型文件夹路径，如不指定则使用exe同目录的models文件夹
   示例: "../UmiOCR-data/plugins/win7_x64_PaddleOCR-json/models"

3. language (必需)
   类型: string
   说明: 语言配置文件路径（相对于models_path）
   可选值:
       - "models/config_chinese.txt"     中文简体
       - "models/config_chinese_cht.txt" 中文繁体
       - "models/config_en.txt"          英文
       - "models/config_japan.txt"       日文
       - "models/config_korean.txt"      韩文
       - "models/config_cyrillic.txt"    西里尔文

4. cpu_threads (可选)
   类型: int
   说明: CPU线程数，建议设置为4-8
   默认: 4
   建议: 根据CPU核心数调整，过高反而会降低性能

5. enable_mkldnn (可选)
   类型: bool
   说明: 是否启用MKL-DNN加速（Intel CPU加速库）
   默认: true
   建议: Intel CPU建议开启，AMD CPU可尝试关闭

6. cls (可选)
   类型: bool
   说明: 是否启用文字方向分类（180度识别）
   默认: false
   建议: 图片方向不正时开启，会略微降低速度

7. limit_side_len (可选)
   类型: int
   说明: 图片长边压缩限制（像素）
   默认: 4320
   建议: 大图片会自动压缩到此尺寸，提高识别速度

【配置示例】

# 中文识别（默认配置）
{
    "exe_path": "paddleocr_engine/PaddleOCR-json.exe",
    "models_path": "paddleocr_engine/models",
    "language": "models/config_chinese.txt",
    "cpu_threads": 4,
    "enable_mkldnn": true,
    "cls": false,
    "limit_side_len": 4320
}

# 英文识别
{
    "exe_path": "paddleocr_engine/PaddleOCR-json.exe",
    "models_path": "paddleocr_engine/models",
    "language": "models/config_en.txt",
    "cpu_threads": 4,
    "enable_mkldnn": true,
    "cls": false,
    "limit_side_len": 4320
}

# 性能优先配置
{
    "exe_path": "paddleocr_engine/PaddleOCR-json.exe",
    "models_path": "paddleocr_engine/models",
    "language": "models/config_chinese.txt",
    "cpu_threads": 8,
    "enable_mkldnn": true,
    "cls": false,
    "limit_side_len": 2160
}

================================================================================
                            状态码说明
================================================================================

【识别结果状态码】
100 - 成功：识别到文字
101 - 成功：图片中未识别到文字
901 - 失败：OCR引擎未初始化
902 - 失败：不支持的图片格式
903 - 失败：图片文件不存在
904 - 失败：OCR引擎进程已退出
905 - 失败：OCR识别异常

================================================================================
                            完整使用示例
================================================================================

【示例1: 基础使用】
from ocr_core import OCREngine

# 创建引擎
engine = OCREngine("config.json")

# 初始化
if not engine.initialize():
    print("初始化失败")
    exit()

# 识别图片
result = engine.recognize_image("test.jpg")

# 处理结果
if result["code"] == 100:
    print(f"识别成功，置信度: {result['score']:.2f}")
    
    # 逐行显示
    for item in result["data"]:
        print(f"[{item['score']:.2f}] {item['text']}")
    
    # 提取纯文本
    text = engine.extract_text(result)
    print("\n完整文本:")
    print(text)
elif result["code"] == 101:
    print("图片中未识别到文字")
else:
    print(f"识别失败: {result['data']}")

# 关闭引擎
engine.close()


【示例2: 使用 with 语句（推荐）】
from ocr_core import OCREngine

with OCREngine("config.json") as engine:
    result = engine.recognize_image("test.jpg")
    
    if result["code"] == 100:
        text = engine.extract_text(result)
        print(text)


【示例3: 批量识别】
from ocr_core import OCREngine
import os

# 获取目录下所有图片
image_dir = "images"
image_paths = []
for filename in os.listdir(image_dir):
    if filename.lower().endswith((".jpg", ".png")):
        image_paths.append(os.path.join(image_dir, filename))

# 批量识别
with OCREngine("config.json") as engine:
    results = engine.batch_recognize(image_paths)
    
    # 保存结果
    for result in results:
        if result["code"] == 100:
            text = engine.extract_text(result)
            
            # 保存为txt文件
            txt_path = result["path"].replace(".jpg", ".txt").replace(".png", ".txt")
            with open(txt_path, "w", encoding="utf-8") as f:
                f.write(text)
            
            print(f"已保存: {txt_path}")


【示例4: 处理字节流】
from ocr_core import OCREngine
import requests

# 从网络下载图片
url = "https://example.com/image.jpg"
response = requests.get(url)
image_bytes = response.content

# 识别字节流
with OCREngine("config.json") as engine:
    result = engine.recognize_bytes(image_bytes)
    
    if result["code"] == 100:
        text = engine.extract_text(result)
        print(text)


【示例5: 集成到其他项目】
# 在你的项目中导入
from ocr_core import OCREngine

class MyApplication:
    def __init__(self):
        self.ocr_engine = OCREngine("config.json")
        self.ocr_engine.initialize()
    
    def process_image(self, image_path):
        result = self.ocr_engine.recognize_image(image_path)
        if result["code"] == 100:
            return self.ocr_engine.extract_text(result)
        return None
    
    def cleanup(self):
        self.ocr_engine.close()

# 使用
app = MyApplication()
text = app.process_image("test.jpg")
print(text)
app.cleanup()

================================================================================
                            常见问题
================================================================================

【Q1: 初始化失败怎么办？】
A: 检查以下几点：
   1. 确保 ocr_core 文件夹完整（约200MB）
   2. paddleocr_engine/PaddleOCR-json.exe 是否存在
   3. paddleocr_engine/models 文件夹是否完整
   4. 是否有足够的磁盘空间和内存
   5. Windows 系统可能需要安装 VC++ 运行库

【Q2: 识别速度慢怎么办？】
A: 可以尝试：
   1. 增加 cpu_threads 数量（建议4-8）
   2. 启用 enable_mkldnn（Intel CPU）
   3. 降低 limit_side_len（压缩大图片）
   4. 关闭 cls（如果不需要方向识别）

【Q3: 识别准确率低怎么办？】
A: 可以尝试：
   1. 确保使用了正确的语言配置
   2. 提高图片分辨率和清晰度
   3. 确保图片方向正确，或启用 cls
   4. 预处理图片（二值化、去噪等）

【Q4: 如何识别多种语言？】
A: 修改 config.json 中的 language 配置项，或者创建多个配置文件，
   为不同语言创建不同的 OCREngine 实例。

【Q5: 可以同时运行多个实例吗？】
A: 可以，但每个实例都会占用一定的内存和CPU资源，
   建议根据系统性能合理控制实例数量。

【Q6: 支持 Linux 和 Mac 吗？】
A: 本模块基于 PaddleOCR-json，需要对应平台的可执行文件。
   请查看 PaddleOCR-json 项目获取其他平台版本。

================================================================================
                            技术支持
================================================================================

项目主页: https://github.com/hiroi-sora/Umi-OCR
PaddleOCR-json: https://github.com/hiroi-sora/PaddleOCR-json

版本: 1.0.0
更新日期: 2025-01-04

================================================================================

