================================================================================
                     OCR核心模块 - 功能特性总结
================================================================================

【模块概述】
这是一个从 Umi-OCR 项目中剥离的完全独立、最小化OCR识别核心模块。
包含完整的 PaddleOCR 引擎和模型，可直接复制到任何地方使用，无需额外依赖。

模块大小: 约 336 MB（包含多语言模型）
Python版本: Python 3.8+
平台支持: Windows（已测试）、Linux（理论支持）

================================================================================
                          支持的输入格式
================================================================================

【1. 图片格式】（9种）
  ✓ .jpg / .jpeg / .jpe / .jfif
  ✓ .png
  ✓ .webp
  ✓ .bmp
  ✓ .tif / .tiff

【2. 文档格式】（7种，通过PyMuPDF自动转换）
  ✓ .pdf    - PDF文档（最常用）
  ✓ .xps    - XPS文档
  ✓ .oxps   - Open XPS
  ✓ .epub   - 电子书
  ✓ .mobi   - Kindle电子书
  ✓ .fb2    - FictionBook
  ✓ .cbz    - 漫画书

【3. 其他输入方式】
  ✓ 字节流（bytes）     - 直接识别内存中的图片数据
  ✓ Base64编码          - 识别base64编码的图片字符串
  ✓ 网络URL            - 自动下载并识别网络图片
  ✓ 目录批量           - 扫描目录中所有支持的文件

================================================================================
                          核心功能列表
================================================================================

【基础识别】
1. recognize_image(image_path)
   - 识别本地图片/文档文件
   - 自动识别格式（图片或文档）
   - 支持所有已列出的格式

2. recognize_bytes(image_bytes)
   - 识别字节流数据
   - 适用于内存中的图片
   - 可与网络请求、PIL等库结合使用

3. recognize_base64(image_base64)
   - 识别base64编码的图片
   - 适用于Web API交互
   - 自动解码并识别

【文档识别】（多页支持）
4. recognize_document(doc_path, page_range, dpi, password)
   - 专门用于PDF等多页文档
   - 支持指定页面范围（如第2-5页）
   - 可调整DPI控制质量（默认200）
   - 支持加密文档（提供密码）
   - 返回每页详细结果和合并结果

【网络识别】
5. recognize_url(url, timeout)
   - 自动下载网络图片并识别
   - 支持HTTP/HTTPS
   - 可设置超时时间
   - 自动处理User-Agent

【批量识别】
6. batch_recognize(image_paths)
   - 批量识别多个文件
   - 支持混合格式（图片+文档）
   - 自动处理每个文件
   - 返回完整结果列表

7. recognize_directory(dir_path, recursive)
   - 识别整个目录
   - 可递归扫描子目录
   - 自动过滤支持的格式
   - 批量处理所有文件

【文本提取】
8. extract_text(result)
   - 从识别结果提取纯文本
   - 自动合并所有文本块
   - 按行分隔
   - 忽略位置信息

【生命周期管理】
9. initialize()        - 初始化OCR引擎
10. close()            - 关闭引擎释放资源
11. with语句支持       - 自动管理资源

================================================================================
                          配置参数说明
================================================================================

【配置文件: config.json】

必需参数:
  - exe_path       OCR引擎可执行文件路径（相对路径）
  - models_path    模型文件夹路径（相对路径）
  - language       语言配置文件

可选参数:
  - cpu_threads       CPU线程数（建议4-8）
  - enable_mkldnn     是否启用MKL-DNN加速（Intel CPU推荐）
  - cls               是否启用方向分类（图片旋转识别）
  - limit_side_len    图片长边压缩限制（默认4320px）
  - document_dpi      文档渲染DPI（默认200）

【支持的语言】
  - models/config_chinese.txt      中文简体
  - models/config_chinese_cht.txt  中文繁体
  - models/config_en.txt           英文
  - models/config_japan.txt        日文
  - models/config_korean.txt       韩文
  - models/config_cyrillic.txt     西里尔文

================================================================================
                          返回值格式
================================================================================

【标准返回值】
{
    "code": 100,                 // 状态码
    "score": 0.95,               // 平均置信度
    "data": [                    // 识别结果列表
        {
            "text": "识别的文字",
            "score": 0.95,       // 单块置信度
            "box": [[x1,y1], [x2,y2], [x3,y3], [x4,y4]]  // 四个角坐标
        },
        ...
    ]
}

【文档返回值】（额外字段）
{
    "code": 100,
    "data": [...],              // 所有页面合并的结果
    "score": 0.95,
    "page_count": 10,           // 文档总页数
    "pages": [                  // 每页详细结果
        {
            "page": 1,
            "result": {...}     // 该页的识别结果
        },
        ...
    ]
}

【状态码说明】
  100  成功：识别到文字
  101  成功：图片中未识别到文字
  901  失败：OCR引擎未初始化
  902  失败：不支持的文件格式
  903  失败：文件不存在
  904  失败：OCR引擎进程已退出
  905  失败：OCR识别异常
  910  失败：文档支持未启用（缺少PyMuPDF）
  911  失败：文档已加密，密码错误
  912  失败：文档识别异常
  913  失败：URL下载或识别失败

================================================================================
                          使用场景示例
================================================================================

【场景1: 批量处理扫描文件】
适用于处理大量扫描的图片或PDF文档

from ocr_core import OCREngine

with OCREngine("config.json") as engine:
    results = engine.recognize_directory("./scanned_docs", recursive=True)
    
    for result in results:
        if result["code"] == 100:
            text = engine.extract_text(result)
            # 保存提取的文本
            txt_path = result['path'].replace('.pdf', '.txt')
            with open(txt_path, 'w', encoding='utf-8') as f:
                f.write(text)

【场景2: Web API服务】
将OCR功能封装为Web API

from flask import Flask, request, jsonify
from ocr_core import OCREngine
import base64

app = Flask(__name__)
engine = OCREngine("config.json")
engine.initialize()

@app.route('/ocr', methods=['POST'])
def ocr_api():
    if 'image' in request.json:
        # 处理base64图片
        result = engine.recognize_base64(request.json['image'])
    elif 'url' in request.json:
        # 处理URL
        result = engine.recognize_url(request.json['url'])
    else:
        return jsonify({"error": "No image provided"}), 400
    
    return jsonify(result)

【场景3: 文档内容提取】
从PDF文档中提取特定页面的文字

from ocr_core import OCREngine

with OCREngine("config.json") as engine:
    # 只识别第1-3页，高质量DPI
    result = engine.recognize_document(
        "contract.pdf", 
        page_range=[1, 3],
        dpi=300
    )
    
    if result["code"] == 100:
        # 查看每页内容
        for page_info in result['pages']:
            page_num = page_info['page']
            page_text = engine.extract_text(page_info['result'])
            print(f"第{page_num}页:\n{page_text}\n")

【场景4: 图片爬虫配合】
爬取网站图片并识别其中文字

from ocr_core import OCREngine
import requests
from bs4 import BeautifulSoup

# 爬取图片URL
soup = BeautifulSoup(html, 'html.parser')
image_urls = [img['src'] for img in soup.find_all('img')]

# 批量识别
with OCREngine("config.json") as engine:
    for url in image_urls:
        result = engine.recognize_url(url)
        if result["code"] == 100:
            text = engine.extract_text(result)
            print(f"{url}: {text}")

【场景5: 与PIL/OpenCV集成】
处理图片后再进行OCR

from ocr_core import OCREngine
from PIL import Image
import io

# PIL图片处理
img = Image.open("photo.jpg")
img = img.convert('L')  # 转灰度
img = img.resize((800, 600))  # 调整大小

# 转为字节流识别
buffer = io.BytesIO()
img.save(buffer, format='PNG')
image_bytes = buffer.getvalue()

with OCREngine("config.json") as engine:
    result = engine.recognize_bytes(image_bytes)
    text = engine.extract_text(result)
    print(text)

================================================================================
                          性能优化建议
================================================================================

【识别速度优化】
1. 增加cpu_threads（建议4-8，不要太高）
2. 启用enable_mkldnn（Intel CPU）
3. 降低limit_side_len压缩大图片
4. 关闭cls（如果图片方向都正确）
5. 文档DPI设为150-200（不要太高）

【识别准确率优化】
1. 使用正确的语言配置
2. 提高图片质量和分辨率
3. 预处理图片（去噪、二值化）
4. 启用cls处理旋转图片
5. 文档DPI设为250-300

【内存优化】
1. 处理大批量文件时分批处理
2. 及时调用close()释放资源
3. 使用with语句自动管理
4. 降低document_dpi减少内存占用

================================================================================
                          常见问题解答
================================================================================

Q: 模块可以直接复制使用吗？
A: 是的，整个ocr_core文件夹约336MB，可以直接复制到任何位置使用。

Q: 需要安装什么依赖吗？
A: 不需要，模块已包含所有必需的库和引擎。

Q: 支持哪些操作系统？
A: 主要支持Windows，Linux理论上也支持（需要对应平台的引擎）。

Q: 如何更换识别语言？
A: 修改config.json中的language配置项。

Q: 可以同时运行多个实例吗？
A: 可以，但每个实例会占用约300-500MB内存。

Q: 识别准确率如何？
A: 使用PaddleOCR v3模型，中文识别准确率通常在95%以上。

Q: 支持手写文字吗？
A: 对清晰的手写文字有一定支持，但印刷体效果更好。

Q: 如何处理加密PDF？
A: 使用recognize_document时传入password参数。

Q: 大批量文件会很慢吗？
A: 建议分批处理，或使用多进程并行（每个进程一个实例）。

Q: 可以集成到Web应用吗？
A: 可以，参考场景2的示例代码。

================================================================================
                          更新日志
================================================================================

v1.0.0 (2025-01-04)
  + 初始版本发布
  + 支持9种图片格式
  + 支持7种文档格式
  + 支持PDF多页识别
  + 支持URL网络图片
  + 支持目录批量识别
  + 完整的错误处理
  + 详细的文档和示例
  + 所有测试通过

================================================================================
                          项目信息
================================================================================

原始项目: Umi-OCR
项目主页: https://github.com/hiroi-sora/Umi-OCR
OCR引擎: PaddleOCR-json
引擎主页: https://github.com/hiroi-sora/PaddleOCR-json

本模块特性:
  ✓ 完全独立 - 包含完整引擎和模型
  ✓ 最小代码 - 核心文件不到500行
  ✓ JSON配置 - 灵活调整参数
  ✓ 简洁API - 易于集成
  ✓ 开箱即用 - 无需额外配置
  ✓ 多格式支持 - 图片+文档16种格式
  ✓ 多输入方式 - 路径/字节流/base64/URL
  ✓ 详细文档 - 完整的使用说明

版本: 1.0.0
更新日期: 2025-01-04

================================================================================

