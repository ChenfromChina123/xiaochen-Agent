**1 需求分析**
- **1.1 背景与意义**
  - 终端是开发者高频工作环境，但传统脚本/命令缺少“自然语言意图理解、自动化编排、可追溯与可回滚”能力。
  - 本项目目标：构建一个面向开发场景的终端智能体，支持多模型、工具调用、会话管理、回滚与过程可视化（见 [xiaochen_agent_v2/README.md](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/README.md#L1-L164)）。
- **1.2 目标与范围**
  - 在 CLI 中实现：对话式交互 + 自动工具执行 + 会话持久化 + 安全控制（白名单）+ 日志与统计。
  - 入口与启动：模块入口 [__main__.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/__main__.py#L1-L4)，CLI 主流程 [cli.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L18-L260)。
- **1.3 功能性需求（FR）**
  - FR1 多模型与配置管理：支持预设与运行时切换、配置落盘（见 [cli.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L51-L190)，[Config](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/config.py#L5-L26)，[ConfigManager](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/config_manager.py#L10-L106)）。
  - FR2 会话管理：自动保存、列表、加载、清理、标题生成（见 [SessionManager](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/session.py#L14-L203)）。
  - FR3 工具调用：解析模型输出中的工具标签并执行（解析见 [tags.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/tags.py#L71-L223)，执行分发见 [agent.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/agent.py#L1520-L1595)）。
  - FR4 文件读写与编辑：支持按行读取、按行编辑等能力（见 [files.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/files.py#L136-L215) 与 [files.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/files.py#L217-L260)）。
  - FR5 操作回滚：支持撤销上一次文件操作（见 [rollback_last_edit](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/logs.py#L111-L140)）。
  - FR6 长任务/命令执行与追踪：支持长进程监控、记录 PID 与资源信息（见 [TerminalManager](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/terminal.py#L23-L123)，[ProcessTracker](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/process_tracker.py#L28-L162)）。
  - FR7 友好展示：工具执行头部、结果格式化输出（见 [display.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/display.py#L9-L136)）。
- **1.4 非功能性需求（NFR）**
  - 可用性：Windows 控制台 UTF-8、尽量支持行编辑/历史（见 [cli.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L18-L49)）。
  - 可靠性：会话落盘、异常兜底、回滚机制、超时转长任务（见 [terminal.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/terminal.py#L101-L123)）。
  - 安全性：工具/命令白名单（见 [Config](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/config.py#L14-L26)，[ConfigManager 默认白名单](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/config_manager.py#L15-L36)）。
  - 可维护性：分层结构 core/ui/utils（见根 [README.md](file:///d:/Users/Administrator/User-lab/v2/README.md#L6-L19)）。
- **1.5 典型用例（写成用例表/用例图）**
  - UC1：用户提问→智能体解析→调用 read_file/search→返回答案（解析见 [tags.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/tags.py#L71-L183)）。
  - UC2：用户要求修改文件→edit_lines→记录 edit_history→可 rollback（见 [edit_lines](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/files.py#L217-L260)，[append_edit_history/rollback](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/logs.py#L81-L140)）。
  - UC3：启动时加载历史会话→继续对话→自动保存（见 [cli.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L243-L260)，[session.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/session.py#L135-L203)）。
  - UC4：执行长命令→后台追踪→查看资源（见 [terminal.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/terminal.py#L79-L99)，[process_tracker.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/process_tracker.py#L95-L163)）。

---

**2 总体设计**
- **2.1 架构风格与分层**
  - UI 层：命令行交互、输入归一化、配置引导（[cli.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L18-L236)）
  - Core 层：智能体循环、工具分发、任务管理、缓存统计（[agent.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/agent.py#L46-L186)，[metrics.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/metrics.py#L5-L63)）
  - Utils 层：文件/日志/进程/展示/标签解析（[files.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/files.py#L15-L72)，[logs.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/logs.py#L21-L62)，[display.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/display.py#L9-L136)，[tags.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/tags.py#L71-L223)，[terminal.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/terminal.py#L23-L123)）。
- **2.2 总体流程（建议画时序图）**
  - 用户输入 → CLI 组装配置/历史 → Core 发送请求 → 模型返回（含工具标签）→ 标签解析 → 工具执行 → 观测结果回填 → 显示与会话落盘。
  - 入口链路： [__main__.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/__main__.py#L1-L4) → [run_cli](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L18-L35)。
- **2.3 数据与持久化设计**
  - 配置：`config.json`（字段与默认值见 [config_manager.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/config_manager.py#L15-L36)）。
  - 会话：`logs/sessions/*.json`（格式化为分行列表便于阅读/兼容，见 [session.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/session.py#L115-L133)）。
  - 编辑历史：`logs/void_edit_history.jsonl`（支持回滚，见 [logs.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/logs.py#L81-L140)）。
  - 进程追踪：`logs/process_tracker.json`（见 [process_tracker.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/process_tracker.py#L28-L60)）。
- **2.4 安全与控制策略（总体）**
  - 工具白名单 + 命令白名单作为第一道约束（见 [Config](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/config.py#L14-L26)）。

---

**3 详细设计**
- **3.1 CLI 子系统**
  - Windows 编码统一为 UTF-8；非 Windows 尝试 readline 支持（[cli.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L18-L35)）。
  - 输入清洗：去除控制序列避免方向键污染（[_normalize_user_input](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L36-L49)）。
  - 模型预设与运行时状态输出（[cli.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L59-L185)）。
- **3.2 配置管理**
  - 默认配置结构、读写与更新（[ConfigManager](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/config_manager.py#L10-L106)）。
  - 运行时配置结构（[Config](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/config.py#L5-L26)）。
- **3.3 会话管理**
  - autosave 文件创建、消息分行存储、标题推断与清理策略（[session.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/session.py#L35-L203)）。
- **3.4 工具协议（标签解析）**
  - 支持的工具集合、标签完整性校验、字段解析策略（[parse_stack_of_tags](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/tags.py#L71-L223)）。
- **3.5 工具执行与任务管理**
  - 任务模型与状态归一化（[TaskManager](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/agent.py#L55-L159)）。
  - 工具分发执行与观测回填（示例：task_* 分支见 [agent.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/agent.py#L1520-L1572)）。
- **3.6 文件读取与编辑机制**
  - 限制读取窗口、带行号输出、Python 缩进探测头（[read_range_numbered](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/files.py#L150-L214)）。
  - 行编辑的偏移对齐策略（[edit_lines](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/files.py#L217-L260)）。
- **3.7 回滚与审计**
  - 保存 before 内容（gzip+b64）与 sha256 校验、回滚写回与截断历史（[logs.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/logs.py#L81-L140)）。
- **3.8 进程与长任务管理**
  - 长短任务统一接口、10s 观察窗、超时转长任务（[TerminalManager.run_command](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/terminal.py#L30-L123)）。
  - 进程存活验证与资源采样（[ProcessTracker.get_running_processes](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/process_tracker.py#L95-L163)）。
- **3.9 展示层（可视化输出）**
  - 工具执行头部、SUCCESS/FAILURE 语义化展示（[display.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/display.py#L9-L136)）。

---

**4 实现（按“关键实现点”写，不要逐文件流水账）**
- **4.1 工程结构与入口**
  - 包结构、分层职责、启动入口（[__main__.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/__main__.py#L1-L4)，根目录结构说明见 [README.md](file:///d:/Users/Administrator/User-lab/v2/README.md#L6-L24)）。
- **4.2 配置优先级与落盘**
  - 环境变量/配置文件/交互输入三层合并（实现位置见 [cli.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/ui/cli.py#L186-L223)）。
- **4.3 工具协议落地**
  - 从 LLM 输出解析任务栈（[tags.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/tags.py#L71-L223)）→ 在 Agent 中分发并回填 observations（[agent.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/agent.py#L1520-L1572)）。
- **4.4 可靠性与可控性实现**
  - 回滚：编辑前内容压缩存储+回滚写回（[logs.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/logs.py#L81-L140)）。
  - 长任务：超时/长期进程监控（[terminal.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/terminal.py#L101-L123)）。
  - 中断：中断标志与 KeyboardInterrupt 语义（[interrupt.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/interrupt.py#L10-L37)）。
- **4.5 成本与性能**
  - 缓存命中统计结构与命中率定义（[metrics.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/metrics.py#L5-L53)）。

---

**5 测试**
- **5.1 测试策略**
  - 单元测试：覆盖文件编辑偏移、标签解析健壮性、会话标题回退、读取缩进头等（[test_regressions.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/tests/test_regressions.py#L11-L233)）。
  - 集成测试（建议你写在论文里）：模拟“读文件→改文件→回滚→恢复会话→执行命令”端到端脚本。
- **5.2 测试用例设计（建议列成表）**
  - 输入：工具标签缺字段/未闭合；期望：解析拒绝（见 [test_regressions.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/tests/test_regressions.py#L106-L161)）。
  - 输入：edit_lines 删除后插入；期望：行号对齐正确（见 [test_regressions.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/tests/test_regressions.py#L14-L58)）。
- **5.3 覆盖率与边界**
  - 说明已覆盖的高风险点：解析鲁棒性、文件编辑偏移、会话元数据、外部依赖可选（ruff/psutil）。

---

**6 评估（把“好用/好在哪”量化）**
- **6.1 评估目标与指标**
  - 任务完成率（能否在给定约束下完成目标）。
  - 平均交互轮次/平均耗时（从输入到完成）。
  - 工具调用错误率（解析失败/执行失败/权限拒绝）。
  - 回滚成功率与恢复时间（见回滚实现 [logs.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/utils/logs.py#L111-L140)）。
  - Token 成本与缓存命中率（指标结构见 [metrics.py](file:///d:/Users/Administrator/User-lab/v2/xiaochen_agent_v2/core/metrics.py#L5-L53)）。
- **6.2 实验设计（建议写对比）**
  - 对比组 A：关闭工具调用（纯聊天回答）。
  - 实验组 B：开启工具调用 + 会话保存 + 回滚。
  - 任务集：10~20 个典型开发任务（查找文件、定位函数、批量替换、生成脚本并运行、回滚等）。
- **6.3 结果展示形式**
  - 表：每个任务的成功/失败、轮次、耗时、token、是否触发回滚。
  - 图：缓存命中率曲线、任务耗时箱线图、失败原因分布饼图。

---

**7 总结与展望**
- **7.1 工作总结**
  - 归纳你实现的三件“工程化能力”：可控工具调用协议、可追溯会话与审计、可回滚文件变更。
- **7.2 不足**
  - 外部模型不稳定、离线可复现性不足、权限策略仍偏粗粒度（目前主要依赖白名单）。
- **7.3 展望**
  - 更细粒度权限（路径沙箱/只读模式）、更强回放与 mock、更多评测任务与自动化基准。
